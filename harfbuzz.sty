\ProvidesPackage{harfbuzz}
\RequirePackage{luacode,luatexbase}

\begin{luacode*}
  luaharfbuzz = require "hf_fontload"
\end{luacode*}

\newcommand\startharfbuzz{%
%\begin{luacode*}
\luaexec{
  luatexbase.add_to_callback("pre_linebreak_filter",luaharfbuzz.process_nodes, "harfbuzz")
  -- this fails
  -- luatexbase.add_to_callback("hpack_filter",luaharfbuzz.process_nodes, "harfbuzz_hpack")
}
%\end{luacode*}%
}

\newcommand\stopharfbuzz{%
%\begin{luacode*}
\luaexec{%
  luatexbase.remove_from_callback("pre_linebreak_filter","harfbuzz")
  -- hbox processing sometimes fails
  -- luatexbase.remove_from_callback("pre_linebreak_filter","harfbuzz_hpack")
}
%\end{luacode*}%
}

\newcommand\SetFontOption[2]{%
  \luaexec{%
    luaharfbuzz.options["\luatexluaescapestring{#1}"]="\luatexluaescapestring{#2}"
  }
}

\endinput
